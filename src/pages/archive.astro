---
import { type CollectionEntry, getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";

const posts = (await getCollection("blog")).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const postsByYear: Record<number, CollectionEntry<"blog">[]> = {};

posts.forEach((post) => {
  const year = post.data.pubDate.getFullYear();
  if (!postsByYear[year]) {
    postsByYear[year] = [];
  }
  postsByYear[year].push(post);
});

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<BaseLayout title="Archive" description="A chronological list of all posts.">
  <style slot="head">
    .date-cell {
      width: 8rem; /* Fixed width for date column */
    }
  </style>
  <section class="mx-auto max-w-3xl">
    <h1 class="font-structure-title mb-8 font-serif text-4xl font-bold">
      Archive
    </h1>
    {
      years.map((year) => (
        <div class="mb-12">
          <h2 class="font-structure-title mb-6 border-b pb-2 text-3xl font-bold">
            {year}
          </h2>
          <ul class="space-y-4">
            {postsByYear[Number(year)].map((post) => (
              <li>
                <a href={`/blog/${post.id}/`} class="group flex items-baseline">
                  <div class="date-cell text-sm text-muted-foreground">
                    {post.data.pubDate.toLocaleDateString("en-US", {
                      month: "short",
                      day: "2-digit",
                    })}
                  </div>
                  <h3 class="timeline-link-title font-article-title">
                    {post.data.title}
                  </h3>
                </a>
              </li>
            ))}
          </ul>
        </div>
      ))
    }
  </section>
</BaseLayout>
